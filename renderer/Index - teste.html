<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Enterprise Analytics | Login</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
/* ===== VARIAVEIS & RESET ===== */
:root {
    --primary: #2563eb;
    --primary-dark: #1e3a8a;
    --bg-body: #f1f5f9;
    --bg-card: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --radius: 10px;
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
body { 
    font-family: 'Inter', sans-serif; 
    background-color: var(--bg-body); 
    color: var(--text-main); 
    height: 100vh; 
    overflow: hidden; 
    font-size: 14px;
}

/* ===== TELA DE LOGIN ===== */
#login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
    z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    transition: opacity 0.5s ease;
}
.login-card {
    background: #fff; width: 400px; padding: 40px; border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    text-align: center;
}
.login-logo i { font-size: 48px; color: var(--primary); margin-bottom: 15px; }
.login-title { font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
.login-subtitle { color: #64748b; margin-bottom: 30px; font-size: 14px; }
.btn-google {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;
    background: #fff; color: #334155; font-weight: 600; cursor: pointer;
    transition: 0.2s; font-size: 14px;
}
.btn-google:hover { background: #f8fafc; border-color: #cbd5e1; }
.login-footer { margin-top: 25px; font-size: 12px; color: #94a3b8; }

/* ===== APP WRAPPER ===== */
#app-interface { display: none; width: 100%; height: 100%; display: flex; opacity: 0; transition: opacity 0.5s; }

/* ===== SIDEBAR ===== */
.sidebar { 
    width: 260px; background: #0f172a; color: #fff; display: flex; flex-direction: column; 
    border-right: 1px solid #1e293b; z-index: 20; transition: var(--transition); flex-shrink: 0;
}
.brand { padding: 25px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.brand h2 { font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 600; color: #fff; }
.brand i { font-size: 24px; color: var(--primary); }
.sidebar nav { padding: 20px 10px; flex: 1; display: flex; flex-direction: column; gap: 5px; }
.nav-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 600; padding: 10px 15px; margin-top: 10px; }
.sidebar nav a { 
    color: #94a3b8; padding: 12px 15px; text-decoration: none; font-weight: 500; 
    border-radius: var(--radius); transition: var(--transition); display: flex; align-items: center; gap: 12px;
}
.sidebar nav a:hover { background: rgba(255,255,255,0.05); color: #fff; }
.sidebar nav a.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
.sidebar footer { padding: 20px; font-size: 11px; color: #64748b; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }

/* ===== MAIN AREA ===== */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

/* ===== TOPBAR & USER MENU ===== */
.topbar { 
    background: var(--bg-card); height: 70px; padding: 0 30px; display: flex; justify-content: space-between; 
    align-items: center; border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); z-index: 10;
}
.page-title h1 { font-family: 'Poppins', sans-serif; font-size: 20px; color: var(--text-main); }
.page-title span { color: var(--text-muted); font-size: 13px; }

/* User Dropdown */
.topbar-actions { display: flex; align-items: center; gap: 20px; }
.user-profile { position: relative; cursor: pointer; }
.user-avatar { 
    width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; color: #64748b; overflow: hidden;
    border: 2px solid #fff; box-shadow: 0 0 0 1px #cbd5e1; transition: 0.2s;
}
.user-avatar:hover { box-shadow: 0 0 0 2px var(--primary); }
.user-dropdown {
    position: absolute; top: 50px; right: 0; background: #fff; width: 220px;
    border-radius: 12px; box-shadow: var(--shadow-md); border: 1px solid var(--border);
    display: none; flex-direction: column; padding: 10px; z-index: 100; animation: fadeIn 0.2s ease;
}
.user-dropdown.show { display: flex; }
.user-info { padding: 10px; border-bottom: 1px solid #f1f5f9; margin-bottom: 5px; }
.user-name { font-weight: 600; color: #0f172a; font-size: 14px; display: block; }
.user-email { font-size: 11px; color: #64748b; }
.dropdown-item { 
    padding: 10px; font-size: 13px; color: #334155; text-decoration: none; 
    border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: 0.2s;
}
.dropdown-item:hover { background: #f1f5f9; color: var(--primary); }
.dropdown-item.logout { color: var(--danger); }
.dropdown-item.logout:hover { background: #fef2f2; }

.kpi-badge { 
    background: #eff6ff; color: var(--primary-dark); padding: 8px 16px; border-radius: 30px; 
    font-weight: 600; font-size: 13px; border: 1px solid #bfdbfe; display: flex; align-items: center; gap: 8px;
}

/* ===== VIEW SYSTEM ===== */
.view-section { display: none; padding: 30px; overflow-y: auto; height: calc(100vh - 70px); animation: fadeIn 0.4s ease; }
.view-section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ===== GRID & CARDS ===== */
.dashboard-grid { display: grid; grid-template-columns: 350px 1fr 300px; gap: 25px; height: 100%; align-items: start; }
.card { 
    background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-sm); 
    border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
}
.card-head { 
    padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; 
    justify-content: space-between; align-items: center; background: #fafafa;
}
.card-head h3 { font-size: 14px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; flex: 1; overflow-y: auto; }

/* Metas */
.goal-card {
    background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%); color: #fff; padding: 25px; 
    border-radius: 16px; margin-bottom: 25px; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); position: relative; overflow: hidden;
}
.goal-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; z-index: 2; position: relative;}
.goal-input-group { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px; }
.goal-input-group input { background: transparent; border: none; color: #fff; font-weight: 700; font-size: 16px; width: 100px; text-align: right; }
.goal-input-group input::placeholder { color: rgba(255,255,255,0.5); }
.goal-progress-bg { background: rgba(255,255,255,0.2); height: 10px; border-radius: 5px; width: 100%; position: relative; overflow: hidden; }
.goal-progress-fill { background: #4ade80; height: 100%; border-radius: 5px; width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
.goal-stats { display: flex; justify-content: space-between; margin-top: 10px; font-size: 13px; font-weight: 500; opacity: 0.9; }

/* UI Elements */
.filter-row { display: flex; gap: 8px; }
.input-sm { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: #fff; }
.order-list { list-style: none; max-height: 400px; overflow-y: auto; }
.order-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; margin-bottom: 4px; }
.order-item:hover { background: #f8fafc; }
.order-item.selected { background: #eff6ff; border: 1px solid var(--primary); }
.table-clean { width: 100%; border-collapse: collapse; font-size: 13px; }
.table-clean th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-weight: 600; font-size: 11px; text-transform: uppercase; }
.table-clean td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); }
.table-clean tr:hover { background: #f8fafc; }

/* Metrics */
.metrics-row { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
.metric-card { flex: 1; min-width: 200px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 15px; }
.metric-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
.bg-blue-light { background: #eff6ff; color: var(--primary); }
.bg-green-light { background: #f0fdf4; color: var(--success); }
.bg-orange-light { background: #fff7ed; color: var(--warning); }
.metric-info h4 { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; }
.metric-info .value { font-size: 24px; font-weight: 700; color: var(--text-main); }
.metric-info .sub { font-size: 11px; color: var(--text-muted); display: block; margin-top: 2px; }

/* Modal */
.overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
.overlay.open { display: flex; opacity: 1; }
.modal { background: #fff; width: 600px; max-width: 90%; border-radius: 16px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: translateY(20px); transition: 0.3s; }
.overlay.open .modal { transform: translateY(0); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }
.upload-row { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
.upload-title { width: 100%; margin-bottom: 10px; font-weight: 600; color: #334155; font-size: 14px; display: flex; justify-content: space-between; }
.btn-choose { background: var(--primary); color: #fff; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; font-size: 13px; }
.btn-choose:hover { background: var(--primary-dark); }
.btn-outline { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
.status-pend { color: var(--danger); font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 5px; }
.status-ok { color: var(--success); font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 5px; }
.btn-full { width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
.btn-full:disabled { background: #cbd5e1; cursor: not-allowed; }

/* Responsive */
@media (max-width: 1200px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
@media (max-width: 900px) { .sidebar { display: none; } .dashboard-grid { grid-template-columns: 1fr; } }
</style>
</head>

<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo"><i class="ph ph-chart-polar"></i></div>
            <h1 class="login-title">Enterprise Analytics</h1>
            <p class="login-subtitle">Faça login para acessar seus dashboards</p>
            <button class="btn-google" onclick="handleGoogleLogin()">
                <i class="ph ph-google-logo" style="font-size:18px;"></i> <span>Entrar com Google</span>
            </button>
            <div id="loginLoading" style="display:none; margin-top:20px; color:var(--primary);">
                <i class="ph ph-spinner" style="font-size:24px; animation: spin 1s linear infinite;"></i>
                <div style="font-size:12px; margin-top:5px;">Autenticando...</div>
            </div>
            <div class="login-footer">&copy; 2025 Enterprise Systems</div>
        </div>
    </div>

    <div id="app-interface">
        <aside class="sidebar">
            <div class="brand">
                <i class="ph ph-chart-polar"></i>
                <div>
                    <h2>Analytics</h2>
                    <span style="font-size: 10px; opacity: 0.6; display: block; font-weight: 400;">v3.4 Final Fix</span>
                </div>
            </div>
            <nav>
                <div class="nav-label">Gestão</div>
                <a href="#" class="active" onclick="switchView('view-dashboard', this)"><i class="ph ph-squares-four"></i> Visão Geral</a>
                <a href="#" onclick="switchView('view-faturamento', this); gerarGraficoFaturamento();"><i class="ph ph-currency-dollar"></i> Financeiro</a>
                <div class="nav-label">Inteligência</div>
                <a href="#" onclick="switchView('view-recorrencia', this)"><i class="ph ph-users-three"></i> Clientes (CRM)</a>
                <a href="#" onclick="switchView('view-produtos', this); gerarAnaliseProdutos();"><i class="ph ph-package"></i> Produtos (ABC)</a>
                <div class="nav-label">Dados</div>
                <a href="#" onclick="abrirModal('modalImport')"><i class="ph ph-upload-simple"></i> Importar</a>
                <a href="#" onclick="abrirModalHistorico()"><i class="ph ph-clock-counter-clockwise"></i> Histórico</a>
            </nav>
            <footer>&copy; 2025 Enterprise</footer>
        </aside>

        <main class="main">
            <header class="topbar">
                <div class="page-title"><h1 id="pageTitle">Visão Geral</h1><span id="lastUpdate">Aguardando dados...</span></div>
                <div class="topbar-actions">
                    <div class="kpi-badge"><i class="ph ph-money-wavy"></i><span id="valorTotal">R$ 0,00</span></div>
                    <div class="user-profile" onclick="toggleUserMenu()">
                        <div class="user-avatar"><i class="ph ph-user"></i></div>
                        <div class="user-dropdown" id="userMenu">
                            <div class="user-info"><span class="user-name" id="userNameDisplay">Usuário</span><span class="user-email" id="userEmailDisplay">email@empresa.com</span></div>
                            <a href="#" class="dropdown-item logout" onclick="handleLogout()"><i class="ph ph-sign-out"></i> Sair</a>
                        </div>
                    </div>
                </div>
            </header>

            <div id="view-dashboard" class="view-section active">
                <div class="dashboard-grid">
                    <div class="card" style="height: calc(100vh - 140px);">
                        <div class="card-head"><h3><i class="ph ph-list-dashes"></i> Pedidos</h3><div class="filter-row"><select id="filtroVelocidadeLista" class="input-sm"><option value="Todos">Todos</option><option value="Rápido">Rápido</option><option value="Médio">Médio</option><option value="Lento">Lento</option></select></div></div>
                        <div class="card-body"><ul id="listaPedidos" class="order-list"><li style="text-align:center; padding: 20px; color: #94a3b8;"><i class="ph ph-spinner"></i> Carregue dados...</li></ul></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 25px; overflow-y: auto;">
                        <div style="display: flex; gap: 15px;">
                            <div class="card" style="flex:1; padding: 15px; flex-direction: row; align-items: center; gap: 15px;"><div class="metric-icon bg-blue-light"><i class="ph ph-truck"></i></div><div><span style="font-size:11px; color:#64748b; font-weight:600;">LEAD TIME</span><div id="diasMedios" style="font-size:18px; font-weight:700;">0.0</div></div></div>
                            <div class="card" style="flex:1; padding: 15px; flex-direction: row; align-items: center; gap: 15px;"><div class="metric-icon bg-green-light"><i class="ph ph-check-circle"></i></div><div><span style="font-size:11px; color:#64748b; font-weight:600;">SLA OK</span><div id="pedidosNoPrazo" style="font-size:18px; font-weight:700;">0%</div></div></div>
                        </div>
                        <div class="card" style="flex: 1; min-height: 250px;"><div class="card-head"><h3><i class="ph ph-magnifying-glass"></i> Detalhes</h3></div><div class="card-body" id="detalhesPedidoContainer"><div style="text-align:center; color:#94a3b8; padding-top:40px;"><p>Selecione um pedido.</p></div></div></div>
                        <div class="card" style="height: 250px;"><div class="card-head"><h3><i class="ph ph-trend-up"></i> Eficiência</h3></div><div class="card-body"><canvas id="scatterVpv"></canvas></div></div>
                    </div>
                    <div class="card" style="height: 400px;"><div class="card-head"><h3><i class="ph ph-chart-pie-slice"></i> Velocidade</h3></div><div class="card-body"><div style="height: 200px;"><canvas id="velocidadeChart"></canvas></div></div></div>
                </div>
            </div>

            <div id="view-faturamento" class="view-section">
                <div class="goal-card">
                    <div class="goal-header"><div><h2 style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">Meta Mensal</h2><span style="opacity: 0.8; font-size: 13px;">Defina seu objetivo</span></div><div class="goal-input-group"><span style="font-size:12px; opacity:0.7;">R$</span><input type="text" id="inputMeta" value="0" onchange="atualizarMeta()"><i class="ph ph-pencil-simple" style="font-size:12px; opacity:0.7;"></i></div></div>
                    <div class="goal-progress-bg"><div id="goalProgressBar" class="goal-progress-fill"></div></div>
                    <div class="goal-stats"><span id="goalCurrent">Atual: R$ 0,00</span><span id="goalPercent">0% Atingido</span></div>
                </div>
                <div class="metrics-row">
                    <div class="metric-card"><div class="metric-icon bg-blue-light"><i class="ph ph-coins"></i></div><div class="metric-info"><h4>Faturamento</h4><div class="value" id="fatTotal">R$ 0,00</div></div></div>
                    <div class="metric-card"><div class="metric-icon bg-green-light"><i class="ph ph-trend-up"></i></div><div class="metric-info"><h4>Ticket Médio</h4><div class="value" id="fatTicket">R$ 0,00</div></div></div>
                    <div class="metric-card"><div class="metric-icon bg-orange-light"><i class="ph ph-calendar-check"></i></div><div class="metric-info"><h4>Melhor Mês</h4><div class="value" id="fatMelhorMes">--</div></div></div>
                </div>
                <div class="card"><div class="card-head"><h3><i class="ph ph-chart-line-up"></i> Evolução</h3></div><div class="card-body"><div style="height: 350px;"><canvas id="graficoFaturamento"></canvas></div></div></div>
            </div>

            <div id="view-recorrencia" class="view-section">
                <div id="boxUploadRecorrencia" style="background: #fff; border: 1px dashed var(--primary); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                    <div style="font-size: 14px; font-weight: 500; color: var(--primary-dark);">Carregar Dados Externos?</div>
                    <p style="font-size: 13px; color: var(--text-muted);">Se você já importou os dados na Visão Geral, a análise será automática.</p>
                    <button class="btn-choose" style="width: auto;" onclick="document.getElementById('arquivoRecorrencia').click()">Carregar CRM Extra</button>
                    <input type="file" id="arquivoRecorrencia" accept=".xlsx,.csv" style="display: none;" onchange="processarPlanilhaRecorrencia()">
                </div>
                <div id="recorrenciaResultados" style="display: none;">
                    <div class="metrics-row">
                        <div class="metric-card"><div class="metric-icon bg-blue-light"><i class="ph ph-users"></i></div><div class="metric-info"><h4>Clientes</h4><div class="value" id="kpiClientesUnicos">0</div></div></div>
                        <div class="metric-card"><div class="metric-icon bg-green-light"><i class="ph ph-arrows-clockwise"></i></div><div class="metric-info"><h4>Recorrência</h4><div class="value" id="kpiTaxaRecorrencia">0%</div></div></div>
                        <div class="metric-card"><div class="metric-icon bg-orange-light"><i class="ph ph-crown"></i></div><div class="metric-info"><h4>VIP (A)</h4><div class="value" id="kpiVipCount">0</div></div></div>
                    </div>
                    <div class="card">
                        <div class="card-head">
                            <h3>Classificação</h3>
                            <div class="filter-row">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #64748b;">
                                    <input type="checkbox" id="checkApenasRecorrentes" onchange="renderizarTabelaRecorrencia()"> Apenas Recorrentes
                                </label>
                                <select id="selectOrdenacao" class="input-sm" onchange="renderizarTabelaRecorrencia()">
                                    <option value="valor">Maior Valor</option>
                                    <option value="pedidos">Mais Pedidos</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body"><div id="tabelaRecorrenciaWrapper"></div></div>
                    </div>
                </div>
                <div id="recorrenciaMsg"></div>
            </div>

            <div id="view-produtos" class="view-section">
                <div class="metrics-row">
                    <div class="metric-card"><div class="metric-icon bg-blue-light"><i class="ph ph-package"></i></div><div class="metric-info"><h4>Total SKUs</h4><div class="value" id="prodTotalSku">0</div></div></div>
                    <div class="metric-card"><div class="metric-icon bg-green-light"><i class="ph ph-star"></i></div><div class="metric-info"><h4>Curva A</h4><div class="value" id="prodCurvaA">0</div></div></div>
                    <div class="metric-card"><div class="metric-icon bg-orange-light"><i class="ph ph-warning-circle"></i></div><div class="metric-info"><h4>Cauda Longa</h4><div class="value" id="prodCurvaC">0</div></div></div>
                </div>
                <div class="card"><div class="card-head"><h3><i class="ph ph-list-numbers"></i> Ranking ABC</h3></div><div class="card-body"><div id="tabelaProdutosWrapper"><p style="text-align:center; color:#94a3b8; padding:20px;">Carregue dados primeiro.</p></div></div></div>
            </div>
        </main>
    </div>

    <div id="modalImport" class="overlay">
        <div class="modal">
            <div class="modal-header"><h3>Importar Dados</h3><button class="close-btn" onclick="fecharModal('modalImport')">&times;</button></div>
            <div class="upload-row"><div class="upload-title"><span>1. Vendas por Nota</span><span id="statusNota" class="status-pend">❌ Pendente</span></div><label class="btn-choose" for="planilhaNota">Arquivo</label><input type="file" id="planilhaNota" accept=".xlsx,.csv" hidden /><button class="btn-outline" onclick="gerarModelo('nota')">Modelo</button></div>
            <div class="upload-row"><div class="upload-title"><span>2. Itens (Produtos)</span><span id="statusProduto" class="status-pend">❌ Pendente</span></div><label class="btn-choose" for="planilhaProduto">Arquivo</label><input type="file" id="planilhaProduto" accept=".xlsx,.csv" hidden /><button class="btn-outline" onclick="gerarModelo('produto')">Modelo</button></div>
            <div class="upload-row"><div class="upload-title"><span>3. SLA Site</span><span id="statusSite" class="status-pend">❌ Pendente</span></div><label class="btn-choose" for="planilhaSite">Arquivo</label><input type="file" id="planilhaSite" accept=".xlsx,.csv" hidden /><button class="btn-outline" onclick="gerarModelo('site')">Modelo</button></div>
            <button id="btnGerarAnalise" class="btn-choose btn-full" disabled>Processar Dashboard</button>
        </div>
    </div>

    <div id="modalHistorico" class="overlay">
        <div class="modal" style="width:400px;"><div class="modal-header"><h3>Histórico</h3><button class="close-btn" onclick="fecharModal('modalHistorico')">&times;</button></div><ul id="listaHistorico" style="list-style:none; max-height:300px; overflow-y:auto;"></ul></div>
    </div>

<script>
// --- Globals ---
let historico_por_nota = [], historico_por_produto = [], site = [], pedidos = [], dadosRecorrenciaGlobal = [];
let els = {}; // Element Cache

// --- Utils ---
const formatCurrency = v => v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
const normalizeStr = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase().replace(/[^a-z0-9 ]/g,'');
// Robust Money Parser
const parseMoney = (v) => {
    if(!v) return 0;
    if(typeof v === 'number') return v;
    let s = String(v).trim();
    if(s === '') return 0;
    s = s.replace(/[R$\s]/g,'');
    if(s.includes(',') && s.includes('.')) {
        if(s.lastIndexOf(',') > s.lastIndexOf('.')) s = s.replace(/\./g,'').replace(',','.'); 
        else s = s.replace(/,/g,''); 
    } else if(s.includes(',')) {
        s = s.replace(',','.'); 
    }
    return parseFloat(s) || 0;
};
const parseDate = v => { if(v instanceof Date)return v; if(typeof v==='number')return new Date(Math.round((v-25569)*86400000)); if(typeof v==='string'){ let p=v.split('/'); if(p.length===3)return new Date(p[2],p[1]-1,p[0]); } return null; };
const calcularDias = (d1, d2) => { if(!d1||!d2)return 0; let u=0, c=new Date(d1); c.setHours(0,0,0,0); let e=new Date(d2); e.setHours(0,0,0,0); while(c<e){ if(c.getDay()!==0&&c.getDay()!==6)u++; c.setDate(c.getDate()+1); } return u; };
// Exclusion check for "Total" rows
const checkExclusion = (val) => {
    const s = String(val||'').toLowerCase();
    return s.includes('total') || s.includes('geral') || s === '';
};

// --- Auth Logic ---
function checkLogin() {
    const session = localStorage.getItem('ent_user_session');
    if (session) {
        const user = JSON.parse(session);
        document.getElementById('login-screen').style.display = 'none';
        showApp(user);
    } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app-interface').style.display = 'none';
    }
}

function handleGoogleLogin() {
    document.getElementById('loginLoading').style.display = 'block';
    setTimeout(() => {
        const user = { name: "Admin User", email: "admin@enterprise.com" };
        localStorage.setItem('ent_user_session', JSON.stringify(user));
        document.getElementById('login-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('login-screen').style.display = 'none';
            showApp(user);
        }, 500);
    }, 1000);
}

function handleLogout() {
    if(confirm("Sair?")) {
        localStorage.removeItem('ent_user_session');
        location.reload();
    }
}

function showApp(user) {
    document.getElementById('app-interface').style.display = 'flex';
    setTimeout(() => document.getElementById('app-interface').style.opacity = '1', 50);
    document.getElementById('userNameDisplay').textContent = user.name;
    document.getElementById('userEmailDisplay').textContent = user.email;
    if(sessionStorage.getItem('notaFile')) carregarDados();
}

function toggleUserMenu() { document.getElementById('userMenu').classList.toggle('show'); }
window.onclick = (e) => { if(!e.target.closest('.user-profile')) document.getElementById('userMenu').classList.remove('show'); };

// --- Navigation ---
function switchView(id, el) {
    document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(el) {
        document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('pageTitle').innerText = el.textContent;
    }
}
function abrirModal(id){ document.getElementById(id).classList.add('open'); }
function fecharModal(id){ document.getElementById(id).classList.remove('open'); }

// --- Import Logic ---
document.getElementById('btnGerarAnalise').onclick = async () => {
    const read = f => new Promise(r => { let reader=new FileReader(); reader.onload=e=>r(btoa(new Uint8Array(e.target.result).reduce((d,b)=>d+String.fromCharCode(b),''))); reader.readAsArrayBuffer(f); });
    try {
        const [b1,b2,b3] = await Promise.all([read(document.getElementById('planilhaNota').files[0]), read(document.getElementById('planilhaProduto').files[0]), read(document.getElementById('planilhaSite').files[0])]);
        sessionStorage.setItem('notaFile',b1); sessionStorage.setItem('produtoFile',b2); sessionStorage.setItem('siteFile',b3);
        let hist = JSON.parse(localStorage.getItem('historicoDashboards')||'[]');
        hist.push({timestamp:Date.now(), notaFile:b1, produtoFile:b2, siteFile:b3});
        localStorage.setItem('historicoDashboards', JSON.stringify(hist));
        fecharModal('modalImport'); carregarDados();
    } catch(e){ alert('Erro arquivo'); }
};
['planilhaNota','planilhaProduto','planilhaSite'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
        const has = document.getElementById(id).files.length > 0;
        document.getElementById(id.replace('planilha','status')).innerText = has ? '✅ Pronto' : '❌ Pendente';
        document.getElementById(id.replace('planilha','status')).className = has ? 'status-ok' : 'status-pend';
        document.getElementById('btnGerarAnalise').disabled = !(document.getElementById('planilhaNota').files.length && document.getElementById('planilhaProduto').files.length && document.getElementById('planilhaSite').files.length);
    });
});

function carregarDados() {
    try {
        const load = k => XLSX.utils.sheet_to_json(XLSX.read(atob(sessionStorage.getItem(k)),{type:'binary'}).Sheets[XLSX.read(atob(sessionStorage.getItem(k)),{type:'binary'}).SheetNames[0]]);
        historico_por_nota=load('notaFile'); historico_por_produto=load('produtoFile'); site=load('siteFile');
        if(historico_por_nota.length) {
            processarPedidos(); 
            document.getElementById('lastUpdate').innerText = 'Atualizado: '+new Date().toLocaleTimeString(); 
            gerarAnaliseRecorrenciaGlobal(historico_por_nota);
            setTimeout(atualizarMeta, 500); 
        }
    } catch(e) {}
}

function processarPedidos() {
    const map = new Map(); let totalFat = 0;
    const get = (r, ks) => r[Object.keys(r).find(k=>ks.some(x=>normalizeStr(k).includes(x)))];

    // Iterar primeiro pelas Notas
    historico_por_nota.forEach(notaRow => {
        const pid = get(notaRow,['pedido internet','pedidoid']);
        const cliente = get(notaRow,['cliente','nome']) || 'Consumidor';
        
        if(!pid || checkExclusion(pid) || checkExclusion(cliente)) return;

        const notaNum = get(notaRow,['nota','numero']);
        const emissao = parseDate(get(notaRow,['emissao','data emissao']));
        const saida = parseDate(get(notaRow,['saida','data saida']));
        const valNota = parseMoney(get(notaRow,['total','valor','liquido']));

        if(!emissao || !saida) return;

        if(!map.has(pid)) {
            const dias = calcularDias(emissao, saida);
            map.set(pid, { 
                id:pid, 
                cliente: cliente, 
                dias: dias, 
                emissao: emissao, 
                saida: saida, 
                valorTotal: 0, 
                itens: [], 
                notas: new Set(), 
                velocidade: dias<=3?'Rápido':(dias<=7?'Médio':'Lento') 
            });
        }
        
        const p = map.get(pid);
        if(!p.notas.has(notaNum)) {
            p.valorTotal += valNota;
            totalFat += valNota;
            p.notas.add(notaNum);
        }
        
        if(saida > p.saida) {
            p.saida = saida;
            p.dias = calcularDias(p.emissao, saida);
            p.velocidade = p.dias<=3?'Rápido':(p.dias<=7?'Médio':'Lento');
        }
    });

    // Populamos produtos
    historico_por_produto.forEach(prod => {
        const nota = get(prod,['nota']); 
        for(let [pid, p] of map) {
            if(p.notas.has(nota) || p.notas.has(String(nota))) {
                const sku = get(prod,['sku','codigo']); 
                const qtd = get(prod,['qtd','quant']);
                const valUnit = parseMoney(get(prod, ['valor','preco','unitario','total']));
                const prazo = site.find(s=>get(s,['sku'])==sku) ? get(site.find(s=>get(s,['sku'])==sku),['prazo','disponibilidade']) : '-';
                p.itens.push({sku, qtde:qtd, prazo, valUnitarioReal: valUnit||0});
                break;
            }
        }
    });

    pedidos = Array.from(map.values());
    els.valorTotal.innerText = formatCurrency(totalFat);
    
    const avgDays = pedidos.length ? (pedidos.reduce((a,b)=>a+b.dias,0)/pedidos.length) : 0;
    els.diasMedios.innerText = avgDays.toFixed(1);
    
    const onTime = pedidos.length ? Math.round((pedidos.filter(p=>p.dias<=5).length/pedidos.length)*100) : 0;
    els.pedidosNoPrazo.innerText = onTime + '%';
    
    renderLista(); 
    renderCharts();
}

function renderLista() {
    if (!els.listaPedidos) return;
    const ul = els.listaPedidos; ul.innerHTML='';
    const filVel = els.filtroVel.value;
    pedidos.filter(p=>filVel==='Todos'||p.velocidade===filVel).sort((a,b)=>b.dias-a.dias).slice(0,100).forEach(p=>{
        const li = document.createElement('li'); li.className='order-item';
        li.innerHTML = `<div><strong>#${p.id}</strong><div style="font-size:11px;color:#64748b;">${p.cliente.substr(0,15)}</div></div><div style="text-align:right; font-size:12px; font-weight:bold; color:${p.velocidade==='Rápido'?'#10b981':p.velocidade==='Médio'?'#f59e0b':'#ef4444'}">${p.dias} dias<br><span style="font-size:10px;color:#64748b;font-weight:400;">${formatCurrency(p.valorTotal)}</span></div>`;
        li.onclick=()=>{ 
            document.querySelectorAll('.order-item').forEach(x=>x.classList.remove('selected')); li.classList.add('selected');
            let bc = p.velocidade==='Rápido'?'bg-green-light':(p.velocidade==='Médio'?'bg-orange-light':'bg-red-light');
            els.detalhesContainer.innerHTML = `<div style="animation:fadeIn 0.3s"><div style="background:#f8fafc;padding:10px;border-radius:8px;margin-bottom:15px;border:1px solid #e2e8f0"><div style="display:flex;justify-content:space-between;"><div><h2 style="font-size:16px;color:#1e3a8a">#${p.id}</h2><span style="font-size:12px;color:#64748b;">${p.cliente}</span></div><div class="metric-icon ${bc}" style="width:auto;padding:2px 8px;font-size:11px;font-weight:700;">${p.velocidade}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;font-size:12px;"><div style="color:#64748b">Emissão<br><strong style="color:#333">${p.emissao.toLocaleDateString()}</strong></div><div style="color:#64748b">Entrega<br><strong style="color:#333">${p.saida.toLocaleDateString()}</strong></div><div style="color:#64748b">Total<br><strong style="color:#2563eb">${formatCurrency(p.valorTotal)}</strong></div></div></div><h4 style="font-size:13px;margin-bottom:5px;">Itens (${p.itens.length})</h4><div style="max-height:150px;overflow-y:auto;border:1px solid #f1f5f9"><table class="table-clean"><thead><tr><th>SKU</th><th>Qtd</th></tr></thead><tbody>${p.itens.map(i=>`<tr><td>${i.sku}</td><td>${i.qtde}</td></tr>`).join('')}</tbody></table></div></div>`;
        };
        els.listaPedidos.appendChild(li);
    });
}

function renderCharts() {
    if(els.chartScatter) els.chartScatter.destroy(); 
    if(els.chartVel) els.chartVel.destroy();
    
    els.chartScatter = new Chart(document.getElementById('scatterVpv'), {
        type: 'scatter',
        data: { datasets: [{ label: 'Pedidos', data: pedidos.map(p => ({x: p.dias, y: p.valorTotal})), backgroundColor: '#2563eb', pointRadius: 3 }] },
        options: { maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip: { callbacks: { label: (ctx)=> `R$ ${ctx.raw.y} em ${ctx.raw.x} dias` } } }, scales: { x: { title: {display:true, text:'Dias de Entrega'} }, y: { beginAtZero: true } } }
    });

    const counts = [0,0,0]; 
    pedidos.forEach(p => { if(p.velocidade==='Rápido') counts[0]++; else if(p.velocidade==='Médio') counts[1]++; else counts[2]++; });
    els.chartVel = new Chart(document.getElementById('velocidadeChart'), {
        type: 'doughnut',
        data: { labels: ['Rápido', 'Médio', 'Lento'], datasets: [{ data: counts, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] },
        options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom' } } }
    });
}

function gerarGraficoFaturamento() {
    if(!pedidos.length) return;
    const mes = {}; 
    pedidos.forEach(p=>{ 
        if(p.saida instanceof Date && !isNaN(p.saida)) {
            const k=`${p.saida.getFullYear()}-${(p.saida.getMonth()+1).toString().padStart(2,'0')}`; 
            if(!mes[k])mes[k]=0; mes[k]+=p.valorTotal; 
        }
    });
    const lbls = Object.keys(mes).sort(); const vals = lbls.map(k=>mes[k]);
    document.getElementById('fatTotal').innerText = formatCurrency(vals.reduce((a,b)=>a+b,0));
    document.getElementById('fatTicket').innerText = formatCurrency(pedidos.length ? vals.reduce((a,b)=>a+b,0)/pedidos.length : 0);
    
    if(els.chartFat) els.chartFat.destroy();
    els.chartFat = new Chart(document.getElementById('graficoFaturamento'), { type:'line', data:{ labels:lbls, datasets:[{ label:'Faturamento', data:vals, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.1)', fill:true, tension:0.3 }] }, options:{ maintainAspectRatio:false, plugins:{legend:false}, scales:{x:{grid:{display:false}}} } });
    atualizarMeta();
}

function atualizarMeta() {
    const total = parseMoney(document.getElementById('fatTotal').innerText);
    const input = document.getElementById('inputMeta');
    let meta = parseFloat(localStorage.getItem('meta_faturamento')) || 100000;
    if(input.value == "0" && meta) input.value = meta; else { meta = parseFloat(input.value) || 100000; localStorage.setItem('meta_faturamento', meta); }
    let pct = meta > 0 ? (total/meta)*100 : 0; if(pct>100)pct=100;
    document.getElementById('goalProgressBar').style.width = pct+'%';
    document.getElementById('goalProgressBar').style.backgroundColor = pct<40?'#ef4444':(pct<80?'#f59e0b':'#10b981');
    document.getElementById('goalCurrent').innerText = 'Atual: '+formatCurrency(total);
    document.getElementById('goalPercent').innerText = pct.toFixed(1)+'%';
}

function gerarAnaliseProdutos() {
    if(!pedidos.length) return;
    const map = new Map();
    pedidos.forEach(p => {
        const totalQtd = p.itens.reduce((a,b)=>a+(parseFloat(b.qtde)||1),0);
        const rateio = p.valorTotal / (totalQtd || 1);
        p.itens.forEach(i => {
            const sku = i.sku; const q = parseFloat(i.qtde)||0;
            const val = (i.valUnitarioReal > 0) ? (i.valUnitarioReal > p.valorTotal ? i.valUnitarioReal : i.valUnitarioReal*q) : rateio*q;
            if(!map.has(sku)) map.set(sku, {sku, q:0, v:0});
            const m = map.get(sku); m.q+=q; m.v+=val;
        });
    });
    const list = Array.from(map.values()).sort((a,b)=>b.v-a.v);
    const tot = list.reduce((a,b)=>a+b.v,0); let ac=0;
    list.forEach(i=>{ ac+=i.v; const p=ac/(tot||1); i.c=p<=0.8?'A':(p<=0.95?'B':'C'); });
    
    document.getElementById('prodTotalSku').innerText=list.length;
    document.getElementById('prodCurvaA').innerText=list.filter(x=>x.c=='A').length;
    document.getElementById('prodCurvaC').innerText=list.filter(x=>x.c=='C').length;
    
    let h=`<table class="table-clean"><thead><tr><th>ABC</th><th>SKU</th><th>Qtd</th><th>R$</th></tr></thead><tbody>`;
    list.slice(0,100).forEach(i=>{ h+=`<tr><td><b>${i.c}</b></td><td>${i.sku}</td><td>${i.q}</td><td>${formatCurrency(i.v)}</td></tr>`; });
    document.getElementById('tabelaProdutosWrapper').innerHTML=h+'</tbody></table>';
}

/* --- RECORRÊNCIA (CRM) --- */
function checarDadosRecorrencia() {
    if(dadosRecorrenciaGlobal.length > 0) { 
        document.getElementById('recorrenciaResultados').style.display = 'block'; 
        document.getElementById('boxUploadRecorrencia').style.display = 'none'; 
    } else { 
        document.getElementById('recorrenciaResultados').style.display = 'none'; 
        document.getElementById('boxUploadRecorrencia').style.display = 'flex'; 
    }
}

function processarDadosRecorrencia(rawList) {
    const clientMap = new Map();
    rawList.forEach(c => {
        if(!clientMap.has(c.nome)) clientMap.set(c.nome, { nome: c.nome, pedidos: 0, total: 0 });
        const obj = clientMap.get(c.nome); obj.pedidos += c.pedidos; obj.total += c.total;
    });
    dadosRecorrenciaGlobal = Array.from(clientMap.values()).sort((a,b) => b.total - a.total);
    const tot = dadosRecorrenciaGlobal.reduce((a,b)=>a+b.total,0); let acc=0;
    dadosRecorrenciaGlobal.forEach(c => { acc+=c.total; const p=acc/(tot||1); c.curve = p<=0.8?'A':(p<=0.95?'B':'C'); });
    
    document.getElementById('kpiClientesUnicos').innerText = dadosRecorrenciaGlobal.length;
    document.getElementById('kpiTaxaRecorrencia').innerText = Math.round((dadosRecorrenciaGlobal.filter(c=>c.pedidos>1).length/dadosRecorrenciaGlobal.length)*100) + '%';
    document.getElementById('kpiVipCount').innerText = dadosRecorrenciaGlobal.filter(c=>c.curve==='A').length;
    checarDadosRecorrencia(); renderizarTabelaRecorrencia();
}

function gerarAnaliseRecorrenciaGlobal(dataset) {
    const get = (r, ks) => r[Object.keys(r).find(k=>ks.some(x=>normalizeStr(k).includes(x)))];
    const map = new Map();
    dataset.forEach(row => {
        const nome = String(get(row, ['cliente','nome','razao'])||'').toUpperCase().trim();
        const val = parseMoney(get(row, ['valor total', 'vlr total', 'total da nota', 'valor nota', 'total', 'liquido']));
        const pid = get(row, ['pedido internet','pedido id','pedidoid','nota']);
        if(nome && !checkExclusion(nome) && nome !== 'CONSUMIDOR') {
            if(!map.has(nome)) map.set(nome, { nome, pids: new Set(), total: 0 });
            const c = map.get(nome); if(pid) c.pids.add(pid); c.total += val;
        }
    });
    processarDadosRecorrencia(Array.from(map.values()).map(c => ({ nome: c.nome, pedidos: c.pids.size || 1, total: c.total })));
}

function processarPlanilhaRecorrencia() {
    const f=document.getElementById('arquivoRecorrencia').files[0]; if(!f)return;
    const r=new FileReader(); r.onload=e=>{
        const json=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]]);
        const get = (r, ks) => r[Object.keys(r).find(k=>ks.some(x=>normalizeStr(k).includes(x)))];
        processarDadosRecorrencia(json.map(row => ({
            nome: String(get(row, ['cliente','nome'])||'').toUpperCase().trim(),
            total: parseMoney(get(row, ['valor','total'])),
            pedidos: 1
        })).filter(x => x.nome));
    }; r.readAsArrayBuffer(f);
}

function renderizarTabelaRecorrencia() {
    const chk = document.getElementById('checkApenasRecorrentes');
    const sel = document.getElementById('selectOrdenacao');
    const list = dadosRecorrenciaGlobal.filter(c => !(chk && chk.checked) || c.pedidos > 1);
    
    if(sel) list.sort((a,b) => sel.value === 'valor' ? b.total - a.total : b.pedidos - a.pedidos);
    
    let html = `<table class="table-clean"><thead><tr><th>Curve</th><th>Cliente</th><th style="text-align:center;">Pedidos</th><th style="text-align:right;">LTV Total</th></tr></thead><tbody>`;
    list.slice(0, 100).forEach(c => {
        let bg = c.curve==='A'?'#10b981':(c.curve==='B'?'#f59e0b':'#94a3b8');
        html += `<tr><td><span style="background:${bg}; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">${c.curve}</span></td><td>${c.nome}</td><td style="text-align:center; font-weight:bold;">${c.pedidos}</td><td style="text-align:right;">${formatCurrency(c.total)}</td></tr>`;
    });
    document.getElementById('tabelaRecorrenciaWrapper').innerHTML = html + '</tbody></table>';
}

function abrirModalHistorico() {
    const ul = document.getElementById('listaHistorico'); 
    ul.innerHTML = '';
    const h = JSON.parse(localStorage.getItem('historicoDashboards')||'[]').reverse();
    h.forEach(item => {
        const li = document.createElement('li'); 
        li.style.padding = '10px'; 
        li.style.borderBottom = '1px solid #eee'; 
        li.style.cursor='pointer';
        li.innerHTML = `<strong>${new Date(item.timestamp).toLocaleString()}</strong><br><small>Clique para restaurar</small>`;
        li.onclick = () => { 
            sessionStorage.setItem('notaFile', item.notaFile); 
            sessionStorage.setItem('produtoFile', item.produtoFile); 
            sessionStorage.setItem('siteFile', item.siteFile); 
            fecharModal('modalHistorico'); 
            carregarDados(); 
        };
        ul.appendChild(li);
    });
    abrirModal('modalHistorico');
}

function gerarModelo(t) { 
    const wb = XLSX.utils.book_new(); 
    let d = []; 
    if(t==='nota') d = [['Nota','Pedido Internet','Data Emissao','Data Saida','Valor Total','Cliente']]; 
    if(t==='produto') d = [['Nota','SKU','Qtd','Valor Unitario']]; 
    if(t==='site') d = [['SKU','Prazo Disponibilidade']]; 
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(d), "Modelo"); 
    XLSX.writeFile(wb, `Modelo_${t}.xlsx`); 
}

// Inicialização Segura
document.addEventListener('DOMContentLoaded', () => {
    els = {
        diasMedios: document.getElementById('diasMedios'),
        pedidosNoPrazo: document.getElementById('pedidosNoPrazo'),
        listaPedidos: document.getElementById('listaPedidos'),
        valorTotal: document.getElementById('valorTotal'),
        detalhesContainer: document.getElementById('detalhesPedidoContainer'),
        filtroVel: document.getElementById('filtroVelocidadeLista'),
        chartVel: null, chartFat: null, chartScatter: null
    };
    if(els.filtroVel) els.filtroVel.addEventListener('change', renderLista);
    checkLogin();
});
</script>
</body>
</html>