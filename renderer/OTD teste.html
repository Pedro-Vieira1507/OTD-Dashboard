<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Enterprise Pedidos | Analytics</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
/* ===== VARIAVEIS & RESET ===== */
:root {
    --primary: #2563eb;
    --primary-dark: #1e3a8a;
    --bg-body: #f1f5f9;
    --bg-card: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
    --radius: 10px;
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
body { 
    font-family: 'Inter', sans-serif; 
    background-color: var(--bg-body); 
    color: var(--text-main); 
    display: flex; 
    height: 100vh; 
    overflow: hidden; 
    font-size: 14px;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* ===== SIDEBAR ===== */
.sidebar { 
    width: 260px; 
    background: #0f172a; 
    color: #fff; 
    display: flex; 
    flex-direction: column; 
    border-right: 1px solid #1e293b;
    z-index: 20;
    transition: var(--transition);
}
.brand {
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.brand h2 { font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 600; letter-spacing: -0.5px; color: #fff; }
.brand i { font-size: 24px; color: var(--primary); }

.sidebar nav { padding: 20px 10px; flex: 1; display: flex; flex-direction: column; gap: 5px; }
.nav-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 600; padding: 10px 15px; margin-top: 10px; }
.sidebar nav a { 
    color: #94a3b8; padding: 12px 15px; text-decoration: none; font-weight: 500; 
    border-radius: var(--radius); transition: var(--transition); display: flex; align-items: center; gap: 12px;
}
.sidebar nav a:hover { background: rgba(255,255,255,0.05); color: #fff; }
.sidebar nav a.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
.sidebar nav a i { font-size: 18px; }

.sidebar footer { padding: 20px; font-size: 11px; color: #64748b; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }

/* ===== MAIN AREA ===== */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

/* ===== TOPBAR ===== */
.topbar { 
    background: var(--bg-card); height: 70px; padding: 0 30px; display: flex; justify-content: space-between; 
    align-items: center; border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); z-index: 10;
}
.page-title h1 { font-family: 'Poppins', sans-serif; font-size: 20px; color: var(--text-main); }
.page-title span { color: var(--text-muted); font-size: 13px; font-weight: 400; }

.topbar-actions { display: flex; align-items: center; gap: 15px; }
.kpi-badge { 
    background: #eff6ff; color: var(--primary-dark); padding: 8px 16px; border-radius: 30px; 
    font-weight: 600; font-size: 13px; border: 1px solid #bfdbfe; display: flex; align-items: center; gap: 8px;
}

/* ===== VIEW SYSTEM (SPA FEEL) ===== */
.view-section {
    display: none; /* Hidden by default */
    padding: 30px;
    overflow-y: auto;
    height: calc(100vh - 70px);
    animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.view-section.active { display: block; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== DASHBOARD GRID ===== */
.dashboard-grid { 
    display: grid; grid-template-columns: 350px 1fr 300px; gap: 25px; 
    height: 100%; align-items: start;
}

/* ===== CARDS ===== */
.card { 
    background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-sm); 
    border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
}
.card-head { 
    padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; 
    justify-content: space-between; align-items: center; background: #fafafa;
}
.card-head h3 { font-size: 14px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; flex: 1; overflow-y: auto; }

/* FILTROS */
.filter-row { display: flex; gap: 8px; }
.input-sm { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: #fff; }

/* LISTA DE PEDIDOS */
.order-list { list-style: none; max-height: 400px; overflow-y: auto; }
.order-item { 
    padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; 
    display: flex; justify-content: space-between; align-items: center; border-radius: 6px; margin-bottom: 4px;
}
.order-item:hover { background: #f8fafc; }
.order-item.selected { background: #eff6ff; border: 1px solid var(--primary); }
.order-id { font-weight: 600; color: var(--text-main); }
.order-days { font-size: 12px; font-weight: 500; }

/* DETALHES DO PEDIDO */
.detail-panel { text-align: center; color: var(--text-muted); padding-top: 40px; }
.detail-content { text-align: left; animation: fadeIn 0.3s ease; }
.detail-header-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
.detail-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.meta-item label { display: block; font-size: 10px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
.meta-item strong { font-size: 13px; color: var(--text-main); }

/* TABELA SIMPLES */
.table-clean { width: 100%; border-collapse: collapse; font-size: 13px; }
.table-clean th { text-align: left; padding: 8px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-weight: 600; font-size: 11px; text-transform: uppercase; }
.table-clean td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); }
.table-clean tr:last-child td { border-bottom: none; }

/* ===== METRICS ROW ===== */
.metrics-row { display: flex; gap: 20px; margin-bottom: 25px; }
.metric-card { 
    flex: 1; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); 
    box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 15px;
}
.metric-icon { 
    width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; 
    font-size: 24px; flex-shrink: 0;
}
.bg-blue-light { background: #eff6ff; color: var(--primary); }
.bg-green-light { background: #f0fdf4; color: var(--success); }
.bg-orange-light { background: #fff7ed; color: var(--warning); }

.metric-info h4 { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; }
.metric-info .value { font-size: 24px; font-weight: 700; color: var(--text-main); }
.metric-info .sub { font-size: 11px; color: var(--text-muted); display: block; margin-top: 2px; }

/* ===== NOVOS ESTILOS: METAS (GOALS) ===== */
.goal-card {
    background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
    color: #fff; padding: 25px; border-radius: 16px; margin-bottom: 25px;
    box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
    position: relative; overflow: hidden;
}
.goal-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; z-index: 2; position: relative;}
.goal-input-group { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px; }
.goal-input-group input { 
    background: transparent; border: none; color: #fff; font-weight: 700; font-size: 16px; width: 100px; text-align: right; 
}
.goal-input-group input::placeholder { color: rgba(255,255,255,0.5); }
.goal-progress-bg { background: rgba(255,255,255,0.2); height: 10px; border-radius: 5px; width: 100%; position: relative; overflow: hidden; }
.goal-progress-fill { 
    background: #4ade80; height: 100%; border-radius: 5px; width: 0%; 
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
}
.goal-stats { display: flex; justify-content: space-between; margin-top: 10px; font-size: 13px; font-weight: 500; opacity: 0.9; }

/* ===== UPLOAD OVERLAY ===== */
.overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); 
    backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s;
}
.overlay.open { display: flex; opacity: 1; }
.modal { 
    background: #fff; width: 500px; max-width: 90%; border-radius: 16px; padding: 30px; 
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: translateY(20px); transition: 0.3s;
}
.overlay.open .modal { transform: translateY(0); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); }

.upload-step { margin-bottom: 15px; border: 1px solid var(--border); padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
.btn-primary { 
    background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; 
    font-weight: 600; cursor: pointer; transition: 0.2s; width: 100%; font-size: 14px;
}
.btn-primary:hover { background: var(--primary-dark); }
.btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }
.btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
.status-indicator { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }

/* ===== RECORRENCIA & FATURAMENTO ESPECIFICOS ===== */
.chart-container-lg { height: 350px; width: 100%; position: relative; }
.abc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }

/* Responsive */
@media (max-width: 1200px) {
    .dashboard-grid { grid-template-columns: 1fr 1fr; }
    .col-span-full { grid-column: 1 / -1; }
}
@media (max-width: 900px) {
    .sidebar { display: none; }
    .dashboard-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

    <aside class="sidebar">
        <div class="brand">
            <i class="ph ph-chart-polar"></i>
            <div>
                <h2>Analytics</h2>
                <span style="font-size: 10px; opacity: 0.6; display: block; font-weight: 400;">Dashboard v2.1</span>
            </div>
        </div>
        
        <nav>
            <div class="nav-label">Principal</div>
            <a href="#" class="active" onclick="switchView('view-dashboard', this)">
                <i class="ph ph-squares-four"></i> Visão Geral
            </a>
            <a href="#" onclick="switchView('view-faturamento', this); gerarGraficoFaturamento();">
                <i class="ph ph-currency-dollar"></i> Financeiro
            </a>
            
            <div class="nav-label">Análise ABC</div>
            <a href="#" onclick="switchView('view-recorrencia', this)">
                <i class="ph ph-users-three"></i> Recorrência (CRM)
            </a>
            <a href="#" onclick="switchView('view-produtos', this); gerarAnaliseProdutos();">
                <i class="ph ph-package"></i> Ranking Produtos
            </a>

            <div class="nav-label">Dados</div>
            <a href="#" onclick="abrirModal('modalImport')">
                <i class="ph ph-upload-simple"></i> Importar Dados
            </a>
            <a href="#" onclick="abrirModalHistorico()">
                <i class="ph ph-clock-counter-clockwise"></i> Histórico
            </a>
        </nav>
        
        <footer>
            &copy; 2025 Enterprise Pedidos
        </footer>
    </aside>

    <main class="main">
        <header class="topbar">
            <div class="page-title">
                <h1 id="pageTitle">Visão Geral</h1>
                <span id="lastUpdate">Atualizado: --/--/----</span>
            </div>
            <div class="topbar-actions">
                <div class="kpi-badge">
                    <i class="ph ph-money-wavy"></i>
                    <span id="valorTotal">R$ 0,00</span>
                </div>
                <div style="width: 35px; height: 35px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b;">
                    <i class="ph ph-user"></i>
                </div>
            </div>
        </header>

        <div id="view-dashboard" class="view-section active">
            <div class="dashboard-grid">
                
                <div class="card" style="height: calc(100vh - 140px);">
                    <div class="card-head">
                        <h3><i class="ph ph-list-dashes"></i> Pedidos Recentes</h3>
                        <div class="filter-row">
                            <select id="filtroVelocidadeLista" class="input-sm">
                                <option value="Todos">Todos</option>
                                <option value="Rápido">Rápido</option>
                                <option value="Médio">Médio</option>
                                <option value="Lento">Lento</option>
                            </select>
                            <input type="number" id="filtroDiasLista" class="input-sm" placeholder="Dias..." style="width: 60px;">
                        </div>
                    </div>
                    <div class="card-body">
                        <ul id="listaPedidos" class="order-list">
                            <li style="text-align:center; padding: 20px; color: #94a3b8;">
                                <i class="ph ph-spinner" style="animation: spin 1s linear infinite;"></i> Aguardando dados...
                            </li>
                        </ul>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 25px; height: calc(100vh - 140px); overflow-y: auto;">
                    
                    <div style="display: flex; gap: 15px;">
                        <div class="card" style="flex:1; padding: 15px; flex-direction: row; align-items: center; gap: 15px;">
                            <div class="metric-icon bg-blue-light"><i class="ph ph-truck"></i></div>
                            <div>
                                <span style="font-size:11px; color:#64748b; font-weight:600;">MÉDIA DIAS</span>
                                <div id="diasMedios" style="font-size:18px; font-weight:700;">0.0</div>
                            </div>
                        </div>
                        <div class="card" style="flex:1; padding: 15px; flex-direction: row; align-items: center; gap: 15px;">
                            <div class="metric-icon bg-green-light"><i class="ph ph-check-circle"></i></div>
                            <div>
                                <span style="font-size:11px; color:#64748b; font-weight:600;">NO PRAZO</span>
                                <div id="pedidosNoPrazo" style="font-size:18px; font-weight:700;">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="flex: 1; min-height: 300px;">
                        <div class="card-head">
                            <h3><i class="ph ph-magnifying-glass"></i> Detalhes do Pedido</h3>
                        </div>
                        <div class="card-body" id="detalhesPedidoContainer">
                            <div class="detail-panel">
                                <i class="ph ph-cursor-click" style="font-size: 32px; margin-bottom: 10px;"></i>
                                <p>Selecione um pedido na lista para ver os detalhes.</p>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="height: 300px;">
                        <div class="card-head">
                            <h3><i class="ph ph-trend-up"></i> Eficiência (Valor x Tempo)</h3>
                        </div>
                        <div class="card-body">
                            <div style="height: 100%; width: 100%;">
                                <canvas id="scatterVpv"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="height: 400px;">
                    <div class="card-head">
                        <h3><i class="ph ph-chart-pie-slice"></i> Velocidade</h3>
                    </div>
                    <div class="card-body" style="display: flex; flex-direction: column; justify-content: center;">
                        <div style="height: 200px;">
                            <canvas id="velocidadeChart"></canvas>
                        </div>
                        <div style="margin-top: 20px; font-size: 12px; color: #64748b; text-align: center;">
                            Distribuição baseada no tempo de entrega (Lead Time).
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="view-faturamento" class="view-section">
            
            <div class="goal-card">
                <i class="ph ph-target" style="position: absolute; right: -20px; top: -20px; font-size: 150px; opacity: 0.1; transform: rotate(15deg);"></i>
                <div class="goal-header">
                    <div>
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">Meta Mensal</h2>
                        <span style="opacity: 0.8; font-size: 13px;">Defina seu objetivo de faturamento</span>
                    </div>
                    <div class="goal-input-group">
                        <span style="font-size:12px; opacity:0.7;">R$</span>
                        <input type="text" id="inputMeta" value="0" onchange="atualizarMeta()">
                        <i class="ph ph-pencil-simple" style="font-size:12px; opacity:0.7;"></i>
                    </div>
                </div>
                
                <div class="goal-progress-bg">
                    <div id="goalProgressBar" class="goal-progress-fill"></div>
                </div>
                
                <div class="goal-stats">
                    <span id="goalCurrent">Atual: R$ 0,00</span>
                    <span id="goalPercent">0% Atingido</span>
                </div>
            </div>

            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-icon bg-blue-light"><i class="ph ph-coins"></i></div>
                    <div class="metric-info">
                        <h4>Faturamento Total Analisado</h4>
                        <div class="value" id="fatTotal">R$ 0,00</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon bg-green-light"><i class="ph ph-trend-up"></i></div>
                    <div class="metric-info">
                        <h4>Ticket Médio</h4>
                        <div class="value" id="fatTicket">R$ 0,00</div>
                        <span class="sub">Por pedido</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon bg-orange-light"><i class="ph ph-calendar-check"></i></div>
                    <div class="metric-info">
                        <h4>Melhor Mês</h4>
                        <div class="value" id="fatMelhorMes">--</div>
                        <span class="sub">Pico de vendas</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-head">
                    <h3><i class="ph ph-chart-line-up"></i> Evolução Mensal</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container-lg">
                        <canvas id="graficoFaturamento"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-recorrencia" class="view-section">
            <div style="background: #fff; border: 1px dashed var(--primary); padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                <div style="font-size: 14px; font-weight: 500; color: var(--primary-dark);">Nova Análise de CRM?</div>
                <p style="font-size: 13px; color: var(--text-muted);">Faça upload de uma planilha contendo colunas <strong>Cliente</strong> e <strong>Valor</strong>.</p>
                <input type="file" id="arquivoRecorrencia" accept=".xlsx,.xls,.csv" style="display: none;" onchange="processarPlanilhaRecorrencia()">
                <button class="btn-primary" style="width: auto;" onclick="document.getElementById('arquivoRecorrencia').click()">
                    <i class="ph ph-file-csv"></i> Carregar Dados
                </button>
            </div>

            <div id="recorrenciaResultados" style="display: none;">
                <h3 style="margin-bottom: 20px; color: var(--text-main);">Resultados da Análise</h3>
                <div class="abc-grid">
                    <div class="metric-card">
                        <div class="metric-icon bg-blue-light"><i class="ph ph-users"></i></div>
                        <div class="metric-info">
                            <h4>Base de Clientes</h4>
                            <div class="value" id="kpiClientesUnicos">0</div>
                            <span class="sub">Total Únicos</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon bg-green-light"><i class="ph ph-arrows-clockwise"></i></div>
                        <div class="metric-info">
                            <h4>Taxa de Recorrência</h4>
                            <div class="value" id="kpiTaxaRecorrencia">0%</div>
                            <span class="sub" id="kpiRecorrentesAbs">0 clientes voltaram</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon bg-orange-light"><i class="ph ph-crown"></i></div>
                        <div class="metric-info">
                            <h4>Clientes VIP (Curva A)</h4>
                            <div class="value" id="kpiVipCount">0</div>
                            <span class="sub">Representam 80% da receita</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-head">
                        <h3><i class="ph ph-table"></i> Detalhamento por Cliente</h3>
                        <div class="filter-row">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #64748b;">
                                <input type="checkbox" id="checkApenasRecorrentes" onchange="renderizarTabelaRecorrencia()"> Apenas Recorrentes
                            </label>
                            <select id="selectOrdenacao" class="input-sm" onchange="renderizarTabelaRecorrencia()">
                                <option value="valor">Maior Valor</option>
                                <option value="pedidos">Mais Pedidos</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="tabelaRecorrenciaWrapper"></div>
                    </div>
                </div>
            </div>
            <div id="recorrenciaMsg"></div>
        </div>

        <div id="view-produtos" class="view-section">
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-icon bg-blue-light"><i class="ph ph-package"></i></div>
                    <div class="metric-info"><h4>Total SKUs</h4><div class="value" id="prodTotalSku">0</div><span class="sub">Itens movimentados</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon bg-green-light"><i class="ph ph-star"></i></div>
                    <div class="metric-info"><h4>Curva A</h4><div class="value" id="prodCurvaA">0</div><span class="sub">Produtos Campeões (80% receita)</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon bg-orange-light"><i class="ph ph-warning-circle"></i></div>
                    <div class="metric-info"><h4>Cauda Longa (C)</h4><div class="value" id="prodCurvaC">0</div><span class="sub">Baixo impacto financeiro</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-head">
                    <h3><i class="ph ph-list-numbers"></i> Ranking de Produtos (ABC Real)</h3>
                </div>
                <div class="card-body">
                    <div id="tabelaProdutosWrapper">
                        <p style="text-align:center; color:#94a3b8; padding:20px;">Carregue os dados na aba "Visão Geral" primeiro.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="modalImport" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Importar Dados</h3>
                <button class="close-btn" onclick="fecharModal('modalImport')">&times;</button>
            </div>
            
            <div class="upload-step">
                <div>
                    <strong>1. Vendas por Nota</strong>
                    <div id="statusNota" class="status-indicator" style="color:#ef4444;"><i class="ph ph-x-circle"></i> Pendente</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-ghost" onclick="document.getElementById('planilhaNota').click()">Escolher</button>
                    <button class="btn-ghost" onclick="gerarModelo('nota')" title="Baixar Modelo"><i class="ph ph-download-simple"></i></button>
                </div>
                <input type="file" id="planilhaNota" hidden accept=".xlsx,.csv" />
            </div>

            <div class="upload-step">
                <div>
                    <strong>2. Itens por Produto</strong>
                    <div id="statusProduto" class="status-indicator" style="color:#ef4444;"><i class="ph ph-x-circle"></i> Pendente</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-ghost" onclick="document.getElementById('planilhaProduto').click()">Escolher</button>
                    <button class="btn-ghost" onclick="gerarModelo('produto')"><i class="ph ph-download-simple"></i></button>
                </div>
                <input type="file" id="planilhaProduto" hidden accept=".xlsx,.csv" />
            </div>

            <div class="upload-step">
                <div>
                    <strong>3. Base Site (SLA)</strong>
                    <div id="statusSite" class="status-indicator" style="color:#ef4444;"><i class="ph ph-x-circle"></i> Pendente</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-ghost" onclick="document.getElementById('planilhaSite').click()">Escolher</button>
                    <button class="btn-ghost" onclick="gerarModelo('site')"><i class="ph ph-download-simple"></i></button>
                </div>
                <input type="file" id="planilhaSite" hidden accept=".xlsx,.csv" />
            </div>

            <button id="btnGerarAnalise" class="btn-primary" disabled style="margin-top: 15px;">
                Processar Dashboard
            </button>
        </div>
    </div>

    <div id="modalHistorico" class="overlay">
        <div class="modal" style="width: 400px;">
            <div class="modal-header">
                <h3>Histórico de Importações</h3>
                <button class="close-btn" onclick="fecharModal('modalHistorico')">&times;</button>
            </div>
            <ul id="listaHistorico" style="list-style: none; max-height: 300px; overflow-y: auto;">
                </ul>
        </div>
    </div>

<script>
/* ============================================================
   LÓGICA DO SISTEMA - V2.2
   ============================================================ */

// Estado Global
let historico_por_nota = [];
let historico_por_produto = [];
let site = [];
let produtosEnriquecidos = [];
let pedidos = [];
let dadosRecorrenciaGlobal = []; 

// Elementos DOM Caches
const els = {
    diasMedios: document.getElementById('diasMedios'),
    pedidosNoPrazo: document.getElementById('pedidosNoPrazo'),
    listaPedidos: document.getElementById('listaPedidos'),
    valorTotal: document.getElementById('valorTotal'),
    detalhesContainer: document.getElementById('detalhesPedidoContainer'),
    filtroVel: document.getElementById('filtroVelocidadeLista'),
    filtroDias: document.getElementById('filtroDiasLista'),
    chartVel: null, chartFat: null, chartScatter: null
};

let historicoDashboards = JSON.parse(localStorage.getItem('historicoDashboards')||'[]');

/* --- Navegação SPA --- */
function switchView(viewId, linkElement) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');
    
    if(linkElement) {
        document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
        linkElement.classList.add('active');
        document.getElementById('pageTitle').innerText = linkElement.innerText.trim();
    }
}

function abrirModal(id) { document.getElementById(id).classList.add('open'); }
function fecharModal(id) { document.getElementById(id).classList.remove('open'); }

/* --- Utils --- */
const formatCurrency = (v) => v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
const normalizeStr = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase().replace(/[^a-z0-9 ]/g,'');
const parseMoney = (v) => {
    if(!v) return 0;
    let s = String(v).trim().replace(/[R$\s]/g,'');
    if(s.includes(',') && !s.includes('.')) s = s.replace(',','.');
    else if(s.includes('.') && s.includes(',')) s = s.replace(/\./g,'').replace(',','.');
    return parseFloat(s) || 0;
};
const parseExcelDate = (v) => {
    if(v instanceof Date) return v;
    if(typeof v === 'number') return new Date(Math.round((v - 25569) * 86400 * 1000));
    if(typeof v === 'string') {
        const parts = v.split('/');
        if(parts.length===3) return new Date(parts[2], parts[1]-1, parts[0]);
    }
    return null;
};
function calcularDias(d1, d2) {
    if(!d1 || !d2) return 0;
    let uteis = 0, curr = new Date(d1); curr.setHours(0,0,0,0); d2.setHours(0,0,0,0);
    while(curr < d2) {
        if(curr.getDay() !== 0 && curr.getDay() !== 6) uteis++;
        curr.setDate(curr.getDate()+1);
    }
    return uteis;
}

/* --- Core Logic: Carga de Dados --- */
function checkFilesReady() {
    const f1 = document.getElementById('planilhaNota').files.length;
    const f2 = document.getElementById('planilhaProduto').files.length;
    const f3 = document.getElementById('planilhaSite').files.length;
    
    document.getElementById('statusNota').className = f1 ? 'status-indicator text-success' : 'status-indicator';
    document.getElementById('statusNota').innerHTML = f1 ? '✅ Pronto' : '<i class="ph ph-x-circle"></i> Pendente';
    
    document.getElementById('statusProduto').innerHTML = f2 ? '✅ Pronto' : '<i class="ph ph-x-circle"></i> Pendente';
    document.getElementById('statusSite').innerHTML = f3 ? '✅ Pronto' : '<i class="ph ph-x-circle"></i> Pendente';
    
    document.getElementById('btnGerarAnalise').disabled = !(f1 && f2 && f3);
}

['planilhaNota','planilhaProduto','planilhaSite'].forEach(id => {
    document.getElementById(id).addEventListener('change', checkFilesReady);
});

document.getElementById('btnGerarAnalise').onclick = async () => {
    const read = (file) => new Promise(resolve => {
        const r = new FileReader();
        r.onload = e => resolve(btoa(new Uint8Array(e.target.result).reduce((d,b)=>d+String.fromCharCode(b),'')));
        r.readAsArrayBuffer(file);
    });

    try {
        const f1 = document.getElementById('planilhaNota').files[0];
        const f2 = document.getElementById('planilhaProduto').files[0];
        const f3 = document.getElementById('planilhaSite').files[0];

        const [b1, b2, b3] = await Promise.all([read(f1), read(f2), read(f3)]);

        sessionStorage.setItem('notaFile', b1);
        sessionStorage.setItem('produtoFile', b2);
        sessionStorage.setItem('siteFile', b3);

        const histItem = { timestamp: Date.now(), notaFile: b1, produtoFile: b2, siteFile: b3 };
        historicoDashboards.push(histItem);
        localStorage.setItem('historicoDashboards', JSON.stringify(historicoDashboards));

        fecharModal('modalImport');
        carregarDados();
    } catch(e) { alert('Erro ao processar arquivos.'); console.error(e); }
};

/* --- Core Logic: Processamento --- */
function carregarDados() {
    const load = (k) => {
        try {
            const b = sessionStorage.getItem(k);
            if(!b) return [];
            const wb = XLSX.read(atob(b), {type:'binary'});
            return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        } catch(e) { return []; }
    };
    historico_por_nota = load('notaFile');
    historico_por_produto = load('produtoFile');
    site = load('siteFile');

    if(historico_por_nota.length) {
        processarPedidos();
        document.getElementById('lastUpdate').innerText = 'Atualizado: ' + new Date().toLocaleString();
        setTimeout(() => atualizarMeta(), 500); // Trigger meta update
    }
}

function processarPedidos() {
    const getCol = (row, opts) => {
        const k = Object.keys(row).find(key => opts.some(opt => normalizeStr(key).includes(opt)));
        return k ? row[k] : null;
    };

    const pedidosMap = new Map();
    let somaTotal = 0;

    historico_por_produto.forEach(prod => {
        const notaNum = getCol(prod, ['nota']);
        const sku = getCol(prod, ['sku','codigo']);
        const qtde = getCol(prod, ['qtd','quant']);
        
        // Tenta achar valor unitário real na linha do produto
        const valUnitarioReal = parseMoney(getCol(prod, ['valor', 'preco', 'vlr', 'unitario', 'total']));

        const notaRow = historico_por_nota.find(n => getCol(n, ['nota']) == notaNum);
        if(!notaRow) return;

        const pedidoId = getCol(notaRow, ['pedido internet','pedido id','pedidoid']);
        const emissao = parseExcelDate(getCol(notaRow, ['emissao','data emissao']));
        const saida = parseExcelDate(getCol(notaRow, ['saida','data saida']));
        const valorNota = parseMoney(getCol(notaRow, ['valor','total','liquido']));
        const cliente = getCol(notaRow, ['cliente','nome']) || 'Consumidor';

        if(!pedidoId || !emissao || !saida) return;

        const siteRow = site.find(s => getCol(s, ['sku']) == sku);
        const prazoTxt = siteRow ? getCol(siteRow, ['prazo','disponibilidade']) : '-';

        if(!pedidosMap.has(pedidoId)) {
            const dias = calcularDias(emissao, saida);
            let vel = 'Lento';
            if(dias <= 3) vel = 'Rápido';
            else if(dias <= 7) vel = 'Médio';

            pedidosMap.set(pedidoId, {
                id: pedidoId, cliente: cliente, dias: dias, emissao: emissao, saida: saida,
                velocidade: vel, valorTotal: 0, itens: [], notasVinculadas: new Set()
            });
        }
        
        const p = pedidosMap.get(pedidoId);
        p.itens.push({ sku, qtde, prazo: prazoTxt, valUnitarioReal: valUnitarioReal || 0 });
        
        if(!p.notasVinculadas.has(notaNum)) {
            p.valorTotal += valorNota;
            somaTotal += valorNota;
            p.notasVinculadas.add(notaNum);
        }
        
        if(saida > p.saida) { 
            p.saida = saida; 
            p.dias = calcularDias(p.emissao, saida);
            if(p.dias <= 3) p.velocidade = 'Rápido';
            else if(p.dias <= 7) p.velocidade = 'Médio';
            else p.velocidade = 'Lento';
        }
    });

    pedidos = Array.from(pedidosMap.values());
    els.valorTotal.innerText = formatCurrency(somaTotal);

    atualizarDashboardUI();
}

function atualizarDashboardUI() {
    if(!pedidos.length) return;
    const media = pedidos.reduce((acc, p) => acc + p.dias, 0) / pedidos.length;
    const noPrazo = pedidos.filter(p => p.dias <= 5).length;
    els.diasMedios.innerText = media.toFixed(1);
    els.pedidosNoPrazo.innerText = Math.round((noPrazo / pedidos.length) * 100) + '%';
    atualizarLista();
    renderCharts();
}

function atualizarLista() {
    const filtroV = els.filtroVel.value;
    const filtroD = els.filtroDias.value;

    const filtrados = pedidos.filter(p => {
        const matchV = filtroV === 'Todos' || p.velocidade === filtroV;
        const matchD = !filtroD || p.dias == filtroD;
        return matchV && matchD;
    });

    filtrados.sort((a,b) => b.dias - a.dias);
    els.listaPedidos.innerHTML = '';
    
    filtrados.slice(0, 100).forEach(p => {
        const li = document.createElement('li');
        li.className = 'order-item';
        let color = '#ef4444';
        if(p.velocidade === 'Rápido') color = '#10b981';
        else if(p.velocidade === 'Médio') color = '#f59e0b';

        li.innerHTML = `
            <div>
                <div class="order-id">#${p.id}</div>
                <div style="font-size:11px; color:#64748b;">${p.cliente.substring(0,20)}...</div>
            </div>
            <div class="order-days" style="color:${color}; text-align:right;">
                ${p.dias} dias<br>
                <span style="font-size:10px; opacity:0.8;">${formatCurrency(p.valorTotal)}</span>
            </div>
        `;
        li.onclick = () => mostrarDetalhes(p, li);
        els.listaPedidos.appendChild(li);
    });
}

function mostrarDetalhes(p, elItem) {
    document.querySelectorAll('.order-item').forEach(x => x.classList.remove('selected'));
    elItem.classList.add('selected');
    let badgeClass = 'bg-orange-light';
    if(p.velocidade === 'Rápido') badgeClass = 'bg-green-light';
    
    els.detalhesContainer.innerHTML = `
        <div class="detail-content">
            <div class="detail-header-box">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <h2 style="font-size:18px; color:var(--primary-dark);">Pedido #${p.id}</h2>
                        <span style="font-size:12px; color:#64748b;">${p.cliente}</span>
                    </div>
                    <div class="metric-icon ${badgeClass}" style="width:auto; padding: 5px 10px; font-size:12px; font-weight:700;">${p.velocidade}</div>
                </div>
                <div class="detail-meta-grid">
                    <div class="meta-item"><label>Emissão</label><strong>${p.emissao.toLocaleDateString()}</strong></div>
                    <div class="meta-item"><label>Despacho</label><strong>${p.saida.toLocaleDateString()}</strong></div>
                    <div class="meta-item"><label>Lead Time</label><strong>${p.dias} dias</strong></div>
                    <div class="meta-item"><label>Valor Total</label><strong style="color:var(--primary);">${formatCurrency(p.valorTotal)}</strong></div>
                </div>
            </div>
            <h4 style="font-size:13px; margin-bottom:10px; color:#334155;">Itens do Pedido (${p.itens.length})</h4>
            <div style="max-height: 200px; overflow-y:auto; border:1px solid #f1f5f9; border-radius:8px;">
                <table class="table-clean">
                    <thead><tr><th>SKU</th><th>Qtd</th><th style="text-align:right;">SLA Site</th></tr></thead>
                    <tbody>${p.itens.map(i => `<tr><td>${i.sku}</td><td style="text-align:center;">${i.qtde}</td><td style="text-align:right; font-size:11px; color:#64748b;">${i.prazo}</td></tr>`).join('')}</tbody>
                </table>
            </div>
        </div>
    `;
}

function renderCharts() {
    const ctxScatter = document.getElementById('scatterVpv').getContext('2d');
    if(els.chartScatter) els.chartScatter.destroy();
    const scatterData = pedidos.map(p => ({ x: p.dias, y: p.valorTotal, color: p.velocidade==='Rápido'?'#10b981':(p.velocidade==='Médio'?'#f59e0b':'#ef4444') }));
    els.chartScatter = new Chart(ctxScatter, { type: 'scatter', data: { datasets: [{ label: 'Pedidos', data: scatterData, backgroundColor: scatterData.map(d => d.color), pointRadius: 4, pointHoverRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip: { callbacks: { label: (ctx)=> `R$ ${ctx.raw.y} em ${ctx.raw.x} dias` } } }, scales: { x: { title: {display:true, text:'Dias'}, grid: {display:false} }, y: { beginAtZero:true, grid: {color:'#f1f5f9'} } } } });

    const counts = { 'Rápido':0, 'Médio':0, 'Lento':0 };
    pedidos.forEach(p => counts[p.velocidade]++);
    const ctxVel = document.getElementById('velocidadeChart').getContext('2d');
    if(els.chartVel) els.chartVel.destroy();
    els.chartVel = new Chart(ctxVel, { type: 'doughnut', data: { labels: ['Rápido', 'Médio', 'Lento'], datasets: [{ data: [counts['Rápido'], counts['Médio'], counts['Lento']], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: {position:'bottom'} } } });
}

/* --- Módulo Faturamento --- */
function gerarGraficoFaturamento() {
    if(!pedidos.length) return;
    const mapMes = {};
    pedidos.forEach(p => { const key = `${p.saida.getFullYear()}-${String(p.saida.getMonth()+1).padStart(2,'0')}`; if(!mapMes[key]) mapMes[key] = { total: 0, count: 0 }; mapMes[key].total += p.valorTotal; mapMes[key].count++; });
    const labels = Object.keys(mapMes).sort();
    const data = labels.map(k => mapMes[k].total);
    const totalGeral = data.reduce((a,b)=>a+b,0);
    const countGeral = labels.reduce((a,k)=>a+mapMes[k].count,0);
    let maxVal = 0; let bestMonth = '-';
    labels.forEach((l, i) => { if(data[i] > maxVal) { maxVal = data[i]; bestMonth = l; } });

    document.getElementById('fatTotal').innerText = formatCurrency(totalGeral);
    document.getElementById('fatTicket').innerText = formatCurrency(totalGeral / (countGeral||1));
    document.getElementById('fatMelhorMes').innerText = bestMonth + ` (${formatCurrency(maxVal)})`;

    const ctx = document.getElementById('graficoFaturamento').getContext('2d');
    if(els.chartFat) els.chartFat.destroy();
    els.chartFat = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Faturamento', data: data, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.3, fill: true, pointRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y: { beginAtZero: true, grid: {color:'#f1f5f9'} }, x: { grid: {display:false} } } } });
    
    atualizarMeta(totalGeral);
}

function atualizarMeta(currentTotal) {
    let total = currentTotal;
    if (typeof total === 'undefined') total = parseMoney(document.getElementById('fatTotal').innerText);
    const input = document.getElementById('inputMeta');
    
    let metaVal;
    const savedMeta = localStorage.getItem('meta_faturamento');
    
    if(input.value == "0" && savedMeta) {
        input.value = savedMeta;
        metaVal = parseFloat(savedMeta);
    } else {
        metaVal = parseFloat(input.value.replace(/[^0-9]/g, '')) || 100000;
        localStorage.setItem('meta_faturamento', metaVal);
    }

    let pct = (total / metaVal) * 100;
    if (pct > 100) pct = 100;

    const bar = document.getElementById('goalProgressBar');
    bar.style.width = pct + '%';
    if(pct < 30) bar.style.backgroundColor = '#ef4444';
    else if(pct < 70) bar.style.backgroundColor = '#f59e0b';
    else bar.style.backgroundColor = '#10b981';

    document.getElementById('goalCurrent').innerText = `Atual: ${formatCurrency(total)}`;
    document.getElementById('goalPercent').innerText = `${pct.toFixed(1)}% Atingido`;
}

/* --- Módulo Produtos (Ranking) --- */
function gerarAnaliseProdutos() {
    if(!pedidos.length) return;

    const prodMap = new Map();

    pedidos.forEach(p => {
        const temValorReal = p.itens.some(i => i.valUnitarioReal > 0);
        const totalItensPedido = p.itens.reduce((acc, i) => acc + (parseFloat(i.qtde)||1), 0);
        const valorMedioRateio = p.valorTotal / (totalItensPedido || 1);

        p.itens.forEach(item => {
            const sku = String(item.sku).trim().toUpperCase();
            const qtd = parseFloat(item.qtde) || 0;
            let receitaItem = 0;

            if(temValorReal && item.valUnitarioReal > 0) {
                if(item.valUnitarioReal > p.valorTotal) receitaItem = item.valUnitarioReal; 
                else receitaItem = item.valUnitarioReal * qtd;
            } else {
                receitaItem = valorMedioRateio * qtd;
            }

            if(!prodMap.has(sku)) prodMap.set(sku, { sku, qtdTotal: 0, valorTotal: 0 });
            const pm = prodMap.get(sku);
            pm.qtdTotal += qtd;
            pm.valorTotal += receitaItem;
        });
    });

    let lista = Array.from(prodMap.values());
    lista.sort((a,b) => b.valorTotal - a.valorTotal);
    const receitaTotal = lista.reduce((sum, i) => sum + i.valorTotal, 0);
    let acumulado = 0;

    lista.forEach(item => {
        acumulado += item.valorTotal;
        const perc = acumulado / receitaTotal;
        if (perc <= 0.80) item.classe = 'A';
        else if (perc <= 0.95) item.classe = 'B';
        else item.classe = 'C';
    });

    document.getElementById('prodTotalSku').innerText = lista.length;
    document.getElementById('prodCurvaA').innerText = lista.filter(x=>x.classe==='A').length;
    document.getElementById('prodCurvaC').innerText = lista.filter(x=>x.classe==='C').length;

    let html = `<table class="table-clean"><thead><tr><th>Classificação</th><th>SKU / Produto</th><th style="text-align:center;">Qtd Vendida</th><th style="text-align:right;">Receita (Real/Est.)</th></tr></thead><tbody>`;

    lista.slice(0, 200).forEach(item => {
        let badgeColor = '#94a3b8';
        if(item.classe === 'A') badgeColor = '#10b981';
        if(item.classe === 'B') badgeColor = '#f59e0b';
        html += `<tr><td><span style="background:${badgeColor}; color:#fff; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:11px;">${item.classe}</span></td><td style="font-weight:500;">${item.sku}</td><td style="text-align:center;">${item.qtdTotal}</td><td style="text-align:right;">${formatCurrency(item.valorTotal)}</td></tr>`;
    });
    html += '</tbody></table>';
    if(lista.length > 200) html += `<div style="text-align:center; padding:10px; color:#999; font-size:11px;">Exibindo top 200 de ${lista.length} produtos</div>`;
    document.getElementById('tabelaProdutosWrapper').innerHTML = html;
}

/* --- Módulo Recorrência --- */
function processarPlanilhaRecorrencia() {
    const file = document.getElementById('arquivoRecorrencia').files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(e.target.result, {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const sample = json[0];
            const keyCliente = Object.keys(sample).find(k => k.toLowerCase().match(/cliente|nome|razao/));
            const keyValor = Object.keys(sample).find(k => k.toLowerCase().match(/valor|total|vlr/));

            if(!keyCliente || !keyValor) { document.getElementById('recorrenciaMsg').innerHTML = '<p style="color:red; margin-top:10px;">Colunas não identificadas.</p>'; return; }

            const clientMap = new Map();
            json.forEach(row => {
                const nome = String(row[keyCliente]||'').toUpperCase().trim();
                const val = parseFloat(String(row[keyValor]).replace(/[^0-9,.-]/g,'').replace(',','.')) || 0;
                if(!clientMap.has(nome)) clientMap.set(nome, { nome, pedidos: 0, total: 0 });
                const c = clientMap.get(nome); c.pedidos++; c.total += val;
            });

            dadosRecorrenciaGlobal = Array.from(clientMap.values());
            dadosRecorrenciaGlobal.sort((a,b) => b.total - a.total);
            const totalRevenue = dadosRecorrenciaGlobal.reduce((acc, c) => acc + c.total, 0);
            let accum = 0;
            dadosRecorrenciaGlobal.forEach(c => { accum += c.total; const perc = accum / totalRevenue; c.curve = perc <= 0.8 ? 'A' : (perc <= 0.95 ? 'B' : 'C'); });

            document.getElementById('kpiClientesUnicos').innerText = dadosRecorrenciaGlobal.length;
            document.getElementById('kpiTaxaRecorrencia').innerText = Math.round((dadosRecorrenciaGlobal.filter(c => c.pedidos > 1).length/dadosRecorrenciaGlobal.length)*100) + '%';
            document.getElementById('kpiVipCount').innerText = dadosRecorrenciaGlobal.filter(c => c.curve === 'A').length;
            document.getElementById('recorrenciaResultados').style.display = 'block';
            renderizarTabelaRecorrencia();
        } catch(err) { alert('Erro na planilha'); console.error(err); }
    };
    reader.readAsArrayBuffer(file);
}

function renderizarTabelaRecorrencia() {
    const onlyRec = document.getElementById('checkApenasRecorrentes').checked;
    const order = document.getElementById('selectOrdenacao').value;
    let list = dadosRecorrenciaGlobal.filter(c => !onlyRec || c.pedidos > 1);
    list.sort((a,b) => { if(order === 'valor') return b.total - a.total; return b.pedidos - a.pedidos; });
    let html = `<table class="table-clean"><thead><tr><th>Classificação</th><th>Cliente</th><th style="text-align:center;">Pedidos</th><th style="text-align:right;">LTV (Total Gasto)</th></tr></thead><tbody>`;
    list.slice(0, 200).forEach(c => {
        let badge = '#94a3b8'; if(c.curve === 'A') badge = '#10b981'; if(c.curve === 'B') badge = '#f59e0b';
        html += `<tr><td><span style="background:${badge}; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">${c.curve}</span></td><td>${c.nome}</td><td style="text-align:center; font-weight:bold;">${c.pedidos}</td><td style="text-align:right;">${formatCurrency(c.total)}</td></tr>`;
    });
    html += '</tbody></table>';
    if(list.length > 200) html += '<div style="text-align:center; padding:10px; color:#999; font-size:11px;">Exibindo top 200</div>';
    document.getElementById('tabelaRecorrenciaWrapper').innerHTML = html;
}

function abrirModalHistorico() {
    const ul = document.getElementById('listaHistorico'); ul.innerHTML = '';
    const h = JSON.parse(localStorage.getItem('historicoDashboards')||'[]').reverse();
    h.forEach(item => {
        const li = document.createElement('li'); li.style.padding = '10px'; li.style.borderBottom = '1px solid #eee'; li.style.cursor='pointer';
        li.innerHTML = `<strong>${new Date(item.timestamp).toLocaleString()}</strong><br><small>Clique para restaurar</small>`;
        li.onclick = () => { sessionStorage.setItem('notaFile', item.notaFile); sessionStorage.setItem('produtoFile', item.produtoFile); sessionStorage.setItem('siteFile', item.siteFile); fecharModal('modalHistorico'); carregarDados(); };
        ul.appendChild(li);
    });
    abrirModal('modalHistorico');
}

function gerarModelo(tipo) {
    const wb = XLSX.utils.book_new();
    let d = [];
    if(tipo==='nota') d = [['Nota','Pedido Internet','Data Emissao','Data Saida','Valor Total','Cliente']];
    if(tipo==='produto') d = [['Nota','SKU','Qtd','Valor Unitario']];
    if(tipo==='site') d = [['SKU','Prazo Disponibilidade']];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(d), "Modelo");
    XLSX.writeFile(wb, `Modelo_${tipo}.xlsx`);
}

// Init
els.filtroVel.addEventListener('change', atualizarLista);
els.filtroDias.addEventListener('input', atualizarLista);
window.onload = () => { if(sessionStorage.getItem('notaFile')) carregarDados(); };
</script>
</body>
</html>